<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Clip Fuse</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¬ Clip Fuse</h1>
            <p>å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯é¸æŠã—ã¦çµåˆ</p>
        </header>

        <main>
            <div class="add-files-section">
                <div id="dropZone" class="drop-zone">
                    <div class="drop-zone-content">
                        <div class="drop-icon">ğŸ“</div>
                        <p>å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                        <button id="selectFilesBtn" class="btn btn-primary">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                    </div>
                </div>
            </div>

            <div class="file-list-section">
                <div class="section-header">
                    <h3>çµåˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ« (ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †åºå¤‰æ›´)</h3>
                    <div class="controls">
                        <button id="clearAllBtn" class="btn btn-secondary">å…¨ã¦ã‚¯ãƒªã‚¢</button>
                        <span id="totalDuration" class="total-duration">ç·æ™‚é–“: 00:00:00</span>
                    </div>
                </div>
                <ul id="fileList" class="file-list"></ul>
            </div>

            <div class="merge-section">
                <div class="output-section">
                    <div class="output-filename">
                        <label for="outputFilename">å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å:</label>
                        <input type="text" id="outputFilename" value="merged_video" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›">
                        <span class="file-extension">.mp4</span>
                    </div>
                    <div class="output-selection">
                        <button id="selectOutputBtn" class="btn btn-secondary">ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</button>
                        <span id="outputPath" class="output-path">ä¿å­˜å…ˆæœªé¸æŠ</span>
                    </div>
                    <div class="output-preview" id="outputPreview" style="display: none;">
                        <span class="preview-label">ä¿å­˜å…ˆ:</span>
                        <span id="fullOutputPath" class="full-path"></span>
                    </div>
                </div>
                <button id="mergeBtn" class="btn btn-success btn-large" disabled>å‹•ç”»ã‚’çµåˆ</button>
            </div>

            <div id="progressBanner" class="progress-banner" style="display: none;">
                <div class="banner-content">
                    <div class="banner-icon">ğŸ¬</div>
                    <div class="banner-text">
                        <div class="banner-title">å‹•ç”»ã‚’çµåˆä¸­...</div>
                        <div class="banner-details">
                            <span id="bannerProgress">å‡¦ç†ä¸­...</span>
                        </div>
                    </div>
                </div>
                <button id="cancelBtn" class="cancel-btn" title="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">âœ•</button>
            </div>

            <div id="progressSection" class="progress-section" style="display: none;">
                <div class="progress-info">
                    <h4>çµåˆä¸­...</h4>
                    <div class="progress-details">
                        <span id="progressPercent">0%</span>
                        <span id="progressTime">00:00:00</span>
                        <span id="progressFps">0 fps</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let videoFiles = [];
        let outputPath = '';
        let sortable;

        // DOMè¦ç´ 
        const dropZone = document.getElementById('dropZone');
        const selectFilesBtn = document.getElementById('selectFilesBtn');
        const fileList = document.getElementById('fileList');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const selectOutputBtn = document.getElementById('selectOutputBtn');
        const outputPathSpan = document.getElementById('outputPath');
        const outputFilename = document.getElementById('outputFilename');
        const outputPreview = document.getElementById('outputPreview');
        const fullOutputPath = document.getElementById('fullOutputPath');
        const mergeBtn = document.getElementById('mergeBtn');
        const progressSection = document.getElementById('progressSection');
        const progressBanner = document.getElementById('progressBanner');
        const cancelBtn = document.getElementById('cancelBtn');
        const totalDurationSpan = document.getElementById('totalDuration');

        // çµåˆå‡¦ç†ã®çŠ¶æ…‹ç®¡ç†ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹ï¼‰
        let mergeState = 'idle'; // 'idle', 'processing', 'completed', 'cancelling'
        let currentOutputPath = '';
        let mergeController = null;
        let totalDurationSeconds = 0;
        let totalInputSize = 0; // ç·å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º
        let mergeStartTime = 0;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹é€²æ—ç›£è¦–
        let progressMonitorInterval = null;

        // Sortable.jsã®åˆæœŸåŒ–
        function initSortable() {
            if (sortable) {
                sortable.destroy();
            }
            sortable = Sortable.create(fileList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dataIdAttr: 'data-file-id', // ãƒ‡ãƒ¼ã‚¿å±æ€§ã§IDã‚’ç®¡ç†
                onEnd: function(evt) {
                    console.log('=== ãƒ•ã‚¡ã‚¤ãƒ«ä¸¦ã³æ›¿ãˆ ===');
                    console.log('ç§»å‹•å‰ã®ä½ç½®:', evt.oldIndex);
                    console.log('ç§»å‹•å¾Œã®ä½ç½®:', evt.newIndex);
                    
                    // é…åˆ—ã®é †åºã‚’æ›´æ–°
                    const movedItem = videoFiles.splice(evt.oldIndex, 1)[0];
                    videoFiles.splice(evt.newIndex, 0, movedItem);
                    
                    // ãƒ‡ãƒãƒƒã‚°: ä¸¦ã³æ›¿ãˆå¾Œã®é †åºã‚’ç¢ºèª
                    console.log('ä¸¦ã³æ›¿ãˆå¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«é †åº:');
                    videoFiles.forEach((file, index) => {
                        console.log(`  ${index + 1}. ${file.name} (${file.path})`);
                    });
                    
                    // ç·æ™‚é–“ã‚’æ›´æ–°
                    updateTotalDuration();
                    
                    // UIã®é †åºãŒé…åˆ—ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                    verifyFileOrder();
                }
            });
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é †åºã®æ¤œè¨¼ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        function verifyFileOrder() {
            const listItems = fileList.querySelectorAll('.file-item');
            console.log('=== é †åºæ¤œè¨¼ ===');
            console.log('é…åˆ—å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°:', videoFiles.length);
            console.log('DOMå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°:', listItems.length);
            
            listItems.forEach((item, index) => {
                const fileId = item.getAttribute('data-file-id');
                const arrayFile = videoFiles[index];
                if (arrayFile && arrayFile.id.toString() === fileId) {
                    console.log(`âœ“ ä½ç½® ${index + 1}: ä¸€è‡´ (${arrayFile.name})`);
                } else {
                    console.warn(`âœ— ä½ç½® ${index + 1}: ä¸ä¸€è‡´ï¼`);
                }
            });
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ï¼ˆWindowsæœ€é©åŒ–ç‰ˆï¼‰
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (!dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('drag-over');
            }
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
            
            console.log('Drop event triggered');
            
            const files = Array.from(e.dataTransfer.files);
            console.log('Total files dropped:', files.length);
            
            // ãƒ•ã‚©ãƒ«ãƒ€ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†åˆ¥
            const videoFiles = [];
            const folders = [];
            
            files.forEach((file, index) => {
                console.log(`Item ${index + 1}:`, {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    path: file.path
                });
                
                // ãƒ•ã‚©ãƒ«ãƒ€ã‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚’åˆ¤å®š
                if (file.type === '' && file.size === 0) {
                    // ãƒ•ã‚©ãƒ«ãƒ€ã®å¯èƒ½æ€§
                    folders.push(file);
                } else {
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                    const isVideoType = file.type.startsWith('video/');
                    const isVideoExtension = /\.(mp4|avi|mov|mkv|flv|wmv|m4v|webm)$/i.test(file.name);
                    
                    if (isVideoType || isVideoExtension) {
                        videoFiles.push(file);
                    }
                }
            });
            
            console.log('Video files found:', videoFiles.length);
            console.log('Folders found:', folders.length);
            
            if (videoFiles.length > 0) {
                const filePaths = videoFiles.map(file => file.path || file.name);
                console.log('Video file paths:', filePaths);
                addFiles(filePaths);
            }
            
            if (folders.length > 0) {
                console.log('Folders detected:', folders.map(f => f.name));
                alert(`ãƒ•ã‚©ãƒ«ãƒ€ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: ${folders.map(f => f.name).join(', ')}\n\nãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã„ã¦å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é¸æŠã—ã¦ãã ã•ã„ã€‚`);
            }
            
            if (videoFiles.length === 0 && folders.length === 0) {
                alert('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å¯¾å¿œå½¢å¼: mp4, avi, mov, mkv, flv, wmv, m4v, webm');
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³
        selectFilesBtn.addEventListener('click', async () => {
            const filePaths = await window.electronAPI.selectFiles();
            if (filePaths.length > 0) {
                addFiles(filePaths);
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚‚å–å¾—ï¼‰
        async function addFiles(filePaths) {
            for (const filePath of filePaths) {
                try {
                    const videoInfo = await window.electronAPI.getVideoInfo(filePath);
                    const fileName = filePath.split('\\').pop() || filePath.split('/').pop();
                    
                    // è¡¨ç¤ºåã®é‡è¤‡ç®¡ç†ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè¡¨ç¤ºåã‚’ç”Ÿæˆï¼‰
                    let displayName = fileName;
                    let counter = 1;
                    
                    // æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã§åŒã˜è¡¨ç¤ºåãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    while (videoFiles.find(f => f.name === displayName)) {
                        const nameWithoutExt = fileName.replace(/\.[^/.]+$/, "");
                        const extension = fileName.match(/\.[^/.]+$/)?.[0] || "";
                        displayName = `${nameWithoutExt} (${counter})${extension}`;
                        counter++;
                    }
                    
                    // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ç”Ÿæˆï¼ˆå†…éƒ¨ç®¡ç†ç”¨ï¼‰
                    const uniqueId = Date.now() + Math.random();
                    
                    videoFiles.push({
                        id: uniqueId,          // å†…éƒ¨è­˜åˆ¥ç”¨ID
                        path: filePath,
                        name: displayName,     // è¡¨ç¤ºç”¨åå‰
                        originalName: fileName, // å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å
                        duration: videoInfo.duration,
                        size: videoInfo.size,  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’è¿½åŠ 
                        addedAt: new Date()    // è¿½åŠ æ—¥æ™‚
                    });
                    
                    console.log(`Added file: ${displayName} (${filePath}) [ID: ${uniqueId}] Size: ${videoInfo.size} bytes`);
                } catch (error) {
                    console.error('å‹•ç”»æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
                    const fileName = filePath.split('\\').pop() || filePath.split('/').pop();
                    
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚åŒæ§˜ã«å‡¦ç†
                    let displayName = fileName;
                    let counter = 1;
                    
                    while (videoFiles.find(f => f.name === displayName)) {
                        const nameWithoutExt = fileName.replace(/\.[^/.]+$/, "");
                        const extension = fileName.match(/\.[^/.]+$/)?.[0] || "";
                        displayName = `${nameWithoutExt} (${counter})${extension}`;
                        counter++;
                    }
                    
                    const uniqueId = Date.now() + Math.random();
                    
                    videoFiles.push({
                        id: uniqueId,
                        path: filePath,
                        name: displayName,
                        originalName: fileName,
                        duration: 0,
                        size: 0, // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚µã‚¤ã‚º0
                        addedAt: new Date(),
                        hasError: true
                    });
                    
                    console.log(`Added file with error: ${displayName} (${filePath}) [ID: ${uniqueId}]`);
                }
            }
            updateFileList();
            updateTotalDuration();
            updateMergeButton();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆæ›´æ–°
        function updateFileList() {
            fileList.innerHTML = '';
            videoFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.setAttribute('data-file-id', file.id); // IDã‚’dataå±æ€§ã¨ã—ã¦è¨­å®š
                li.innerHTML = `
                    <div class="file-info">
                        <div class="drag-handle">â‹®â‹®</div>
                        <div class="file-details">
                            <div class="file-name" title="${file.path}">${file.name}</div>
                            <div class="file-duration">${formatDuration(file.duration)}</div>
                            <div class="file-path">${file.path}</div>
                            ${file.hasError ? '<div class="file-error">âš ï¸ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>' : ''}
                        </div>
                    </div>
                    <button class="remove-btn" data-index="${index}" title="å‰Šé™¤">Ã—</button>
                `;
                
                // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç›´æ¥è¿½åŠ 
                const removeBtn = li.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => removeFile(index));
                
                fileList.appendChild(li);
            });
            initSortable();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        function removeFile(index) {
            console.log(`Removing file at index ${index}`);
            videoFiles.splice(index, 1);
            updateFileList();
            updateTotalDuration();
            updateMergeButton();
        }

        // å…¨ã¦ã‚¯ãƒªã‚¢
        clearAllBtn.addEventListener('click', () => {
            videoFiles = [];
            updateFileList();
            updateTotalDuration();
            updateMergeButton();
        });

        // ç·æ™‚é–“ã¨ã‚µã‚¤ã‚ºæ›´æ–°
        function updateTotalDuration() {
            const totalDuration = videoFiles.reduce((sum, file) => sum + (file.duration || 0), 0);
            const totalSize = videoFiles.reduce((sum, file) => sum + (file.size || 0), 0);
            
            totalDurationSeconds = totalDuration;
            totalInputSize = totalSize; // ç·å…¥åŠ›ã‚µã‚¤ã‚ºã‚’ä¿å­˜
            
            totalDurationSpan.textContent = `ç·æ™‚é–“: ${formatDuration(totalDuration)} (${formatFileSize(totalSize)})`;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDuration(seconds) {
            if (!seconds) return '00:00:00';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€é¸æŠ
        selectOutputBtn.addEventListener('click', async () => {
            const folderPath = await window.electronAPI.selectOutputFolder();
            if (folderPath) {
                outputPath = folderPath;
                outputPathSpan.textContent = folderPath.split('\\').pop() || folderPath.split('/').pop();
                outputPathSpan.title = folderPath;
                updateOutputPreview();
                updateMergeButton();
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«åå…¥åŠ›ã®å¤‰æ›´ç›£è¦–
        outputFilename.addEventListener('input', () => {
            updateOutputPreview();
        });

        // å‡ºåŠ›å…ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
        function updateOutputPreview() {
            if (outputPath && outputFilename.value.trim()) {
                const filename = sanitizeFilename(outputFilename.value.trim()) + '.mp4';
                const fullPath = outputPath + '\\' + filename;
                fullOutputPath.textContent = fullPath;
                fullOutputPath.title = fullPath;
                outputPreview.style.display = 'block';
            } else {
                outputPreview.style.display = 'none';
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«åã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆç„¡åŠ¹ãªæ–‡å­—ã‚’é™¤å»ï¼‰
        function sanitizeFilename(filename) {
            // Windowsã§ä½¿ç”¨ã§ããªã„æ–‡å­—ã‚’é™¤å»
            return filename.replace(/[<>:"/\\|?*]/g, '_').replace(/\s+/g, '_');
        }

        // çµåˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
        function updateMergeButton() {
            const hasFiles = videoFiles.length >= 2;
            const hasOutputPath = outputPath && outputFilename.value.trim();
            mergeBtn.disabled = !hasFiles || !hasOutputPath;
        }

        // çŠ¶æ…‹ã¨UIã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆï¼ˆå…ƒã«æˆ»ã™ï¼‰
        function resetMergeState() {
            console.log('=== çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ ===', 'from:', mergeState, 'to: idle');
            mergeState = 'idle';
            // currentOutputPathã¯ä¿æŒï¼ˆå®Œäº†å¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ãŸã‚ï¼‰
            mergeController = null;
            mergeBtn.disabled = false;
            hideProgressBanner();
            updateMergeButton();
        }

        // å®Œå…¨ãªåˆæœŸåŒ–ï¼ˆãƒ‘ã‚¹ä¿æŒç‰ˆï¼‰
        function fullReset() {
            console.log('=== å®Œå…¨åˆæœŸåŒ–ï¼ˆãƒ‘ã‚¹ä¿æŒï¼‰===');
            mergeState = 'idle';
            // currentOutputPath = ''; // ãƒ‘ã‚¹ã‚’ä¿æŒ
            mergeController = null;
            mergeBtn.disabled = false;
            hideProgressBanner();
            updateMergeButton();
        }

        // æ–°ã—ã„çµåˆå‡¦ç†é–‹å§‹æ™‚ã®ã¿ã®å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
        function completeReset() {
            console.log('=== æ–°è¦å‡¦ç†ç”¨å®Œå…¨ãƒªã‚»ãƒƒãƒˆ ===');
            mergeState = 'idle';
            currentOutputPath = '';
            mergeController = null;
            mergeBtn.disabled = false;
            hideProgressBanner();
            updateMergeButton();
        }

        // çµåˆå®Ÿè¡Œ
        mergeBtn.addEventListener('click', async () => {
            if (videoFiles.length < 2 || !outputPath || !outputFilename.value.trim()) return;
            if (mergeState !== 'idle') return; // å‡¦ç†ä¸­ã¯å®Ÿè¡Œã—ãªã„

            const filename = sanitizeFilename(outputFilename.value.trim()) + '.mp4';
            const fullOutputPath = outputPath + '\\' + filename;

            // ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
            const fileExists = await window.electronAPI.checkFileExists(fullOutputPath);
            
            if (fileExists) {
                const userChoice = await showOverwriteDialog(filename);
                if (userChoice === 'cancel') {
                    return;
                } else if (userChoice === 'rename') {
                    const newFilename = await generateUniqueFilename(outputPath, outputFilename.value.trim());
                    outputFilename.value = newFilename;
                    updateOutputPreview();
                    return;
                }
            }

            // ç¾åœ¨ã®é…åˆ—é †åºã‚’æœ€çµ‚ç¢ºèª
            console.log('=== çµåˆå‡¦ç†é–‹å§‹å‰ã®æœ€çµ‚ç¢ºèª ===');
            console.log('çµåˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ•°:', videoFiles.length);
            console.log('çµåˆé †åº:');
            videoFiles.forEach((file, index) => {
                console.log(`  ${index + 1}. ${file.name}`);
                console.log(`     ãƒ‘ã‚¹: ${file.path}`);
            });

            // å‡¦ç†é–‹å§‹
            console.log('=== çµåˆå‡¦ç†é–‹å§‹ ===');
            mergeState = 'processing';
            currentOutputPath = fullOutputPath;
            mergeController = new AbortController();
            mergeStartTime = Date.now(); // é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
            
            console.log('å‡¦ç†é–‹å§‹æ™‚ã®currentOutputPathè¨­å®š:', currentOutputPath);
            console.log('ç·å…¥åŠ›ã‚µã‚¤ã‚º:', formatFileSize(totalInputSize));
            
            // UIæ›´æ–°
            mergeBtn.disabled = true;
            showProgressBanner();
            resetBannerDisplay(); // ãƒãƒŠãƒ¼è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹é€²æ—ç›£è¦–ã‚’é–‹å§‹
            startProgressMonitoring(fullOutputPath);

            try {
                // ç¾åœ¨ã®é…åˆ—é †åºã§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å–å¾—
                const filePaths = videoFiles.map(f => f.path);
                
                // çµåˆç›´å‰ã®æœ€çµ‚ç¢ºèªãƒ­ã‚°
                console.log('=== FFmpegã«æ¸¡ã™ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆé †åºç¢ºèªï¼‰===');
                filePaths.forEach((path, index) => {
                    console.log(`  ${index + 1}. ${path}`);
                });
                
                const result = await window.electronAPI.mergeVideos(filePaths, fullOutputPath);
                
                // é€²æ—ç›£è¦–ã‚’åœæ­¢
                stopProgressMonitoring();
                
                // æ­£å¸¸å®Œäº†ã®å‡¦ç†ï¼ˆå¸¸ã«æˆåŠŸãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼‰
                if (mergeState === 'processing') {
                    console.log('=== çµåˆå‡¦ç†æ­£å¸¸å®Œäº† ===');
                    mergeState = 'completed';
                    hideProgressBanner();
                    showSuccessMessage(fullOutputPath);
                } else if (mergeState === 'cancelling') {
                    console.log('=== ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­ã«å‡¦ç†å®Œäº† - ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤å®Ÿè¡Œ ===');
                    try {
                        await window.electronAPI.forceDeleteFile(fullOutputPath);
                        console.log('ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†å®Œäº†å¾Œãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤æˆåŠŸ');
                        completeReset();
                    } catch (deleteError) {
                        console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†å®Œäº†å¾Œãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤å¤±æ•—:', deleteError);
                        completeReset();
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + deleteError.message);
                    }
                } else {
                    console.log('=== ä¸æ˜ãªçŠ¶æ…‹ã§ã®å®Œäº† ===', mergeState);
                    completeReset();
                }
            } catch (error) {
                console.error('=== çµåˆå‡¦ç†ã‚¨ãƒ©ãƒ¼ ===', error);
                
                // é€²æ—ç›£è¦–ã‚’åœæ­¢
                stopProgressMonitoring();
                
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¥å¤–ã®ã‚¨ãƒ©ãƒ¼ã®ã¿è¡¨ç¤º
                if (mergeState !== 'cancelling') {
                    resetMergeState();
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                } else {
                    console.log('=== ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ï¼ˆæ­£å¸¸ï¼‰ ===');
                    completeReset();
                }
            }
        });

        // ãƒãƒŠãƒ¼è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹ï¼‰
        function resetBannerDisplay() {
            document.querySelector('.banner-title').textContent = 'å‹•ç”»ã‚’çµåˆä¸­...';
            document.querySelector('.banner-icon').textContent = 'ğŸ¬';
            document.getElementById('bannerProgress').textContent = 'å‡¦ç†ä¸­...';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹é€²æ—ç›£è¦–ã‚’é–‹å§‹
        function startProgressMonitoring(outputPath) {
            console.log('=== ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹é€²æ—ç›£è¦–é–‹å§‹ ===');
            console.log('å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«:', outputPath);
            console.log('ç·å…¥åŠ›ã‚µã‚¤ã‚º:', formatFileSize(totalInputSize));
            
            if (progressMonitorInterval) {
                clearInterval(progressMonitorInterval);
            }
            
            progressMonitorInterval = setInterval(async () => {
                if (mergeState !== 'processing') {
                    console.log('é€²æ—ç›£è¦–åœæ­¢: çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ');
                    clearInterval(progressMonitorInterval);
                    progressMonitorInterval = null;
                    return;
                }
                
                try {
                    const currentSize = await window.electronAPI.getFileSize(outputPath);
                    
                    if (currentSize > 0 && totalInputSize > 0) {
                        // é€²æ—ç‡ã‚’è¨ˆç®—ï¼ˆå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã¯é€šå¸¸å…¥åŠ›ã‚ˆã‚Šå°ã•ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ä¸Šé™ã‚’110%ã«ï¼‰
                        const progressPercent = Math.min(110, Math.round((currentSize / totalInputSize) * 100));
                        const displayPercent = Math.min(100, progressPercent);
                        
                        // æ®‹ã‚Šæ™‚é–“ã®æ¨å®š
                        const elapsedTime = (Date.now() - mergeStartTime) / 1000;
                        let displayText;
                        
                        if (displayPercent >= 100) {
                            displayText = '100% (å®Œäº†å‡¦ç†ä¸­...)';
                        } else if (displayPercent >= 95) {
                            displayText = `${displayPercent}% (ã¾ã‚‚ãªãå®Œäº†...)`;
                        } else if (elapsedTime > 5 && displayPercent > 5) {
                            const estimatedTotalTime = (elapsedTime / displayPercent) * 100;
                            const remainingTime = Math.max(0, estimatedTotalTime - elapsedTime);
                            
                            if (remainingTime < 7200) { // 2æ™‚é–“ä»¥å†…
                                displayText = `${displayPercent}% (æ®‹ã‚Šç´„${formatDuration(remainingTime)})`;
                            } else {
                                displayText = `${displayPercent}% (å‡¦ç†ä¸­...)`;
                            }
                        } else {
                            displayText = `${displayPercent}% (å‡¦ç†ä¸­...)`;
                        }
                        
                        console.log(`é€²æ—æ›´æ–°: ${displayText} (å‡ºåŠ›: ${formatFileSize(currentSize)} / å…¥åŠ›: ${formatFileSize(totalInputSize)})`);
                        
                        // ãƒãƒŠãƒ¼æ›´æ–°
                        document.getElementById('bannerProgress').textContent = displayText;
                    } else {
                        document.getElementById('bannerProgress').textContent = '0% (é–‹å§‹ä¸­...)';
                    }
                } catch (error) {
                    console.warn('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                }
            }, 1000); // 1ç§’é–“éš”ã§ç›£è¦–
        }

        // é€²æ—ç›£è¦–ã‚’åœæ­¢
        function stopProgressMonitoring() {
            if (progressMonitorInterval) {
                clearInterval(progressMonitorInterval);
                progressMonitorInterval = null;
                console.log('é€²æ—ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ');
            }
        }

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆä¿®æ­£ç‰ˆ - ãƒ‘ã‚¹ä¿æŒç¢ºèªï¼‰
        cancelBtn.addEventListener('click', async () => {
            console.log('=== ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³æŠ¼ä¸‹ ===');
            console.log('ç¾åœ¨ã®çŠ¶æ…‹:', mergeState);
            console.log('currentOutputPath:', currentOutputPath);
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯¾è±¡ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (!currentOutputPath) {
                console.log('ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯¾è±¡ãªã— - currentOutputPathãŒç©º');
                alert('å‰Šé™¤å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (mergeState === 'cancelling') {
                console.log('æ—¢ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­');
                return;
            }

            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
            const confirmCancel = await showCancelDialog();
            
            if (confirmCancel) {
                console.log('=== ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºå®š - å‰Šé™¤å®Ÿè¡Œ ===');
                console.log('å‰Šé™¤å¯¾è±¡ãƒ‘ã‚¹:', currentOutputPath);
                
                // ã©ã®çŠ¶æ…‹ã§ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã¯å‰Šé™¤å®Ÿè¡Œ
                mergeState = 'cancelling';
                await executeFileDelete(currentOutputPath);
            } else {
                console.log('=== ã‚­ãƒ£ãƒ³ã‚»ãƒ«å–ã‚Šæ¶ˆã— ===');
                // ä½•ã‚‚ã—ãªã„
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã®å®Ÿè¡Œï¼ˆä¿®æ­£ç‰ˆ - å‰Šé™¤æˆåŠŸæ™‚ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†ä¿®æ­£ï¼‰
        async function executeFileDelete(filePath) {
            console.log('=== ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤å®Ÿè¡Œé–‹å§‹ ===');
            console.log('å¼•æ•°ã§å—ã‘å–ã£ãŸãƒ‘ã‚¹:', filePath);
            console.log('currentOutputPath:', currentOutputPath);
            
            // ãƒ‘ã‚¹ãŒç©ºã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const targetPath = filePath || currentOutputPath;
            
            if (!targetPath) {
                console.error('å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒç©ºã§ã™');
                alert('å‰Šé™¤å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\ncurrentOutputPath: ' + currentOutputPath + '\nfilePath: ' + filePath);
                return;
            }
            
            console.log('å®Ÿéš›ã«å‰Šé™¤ã™ã‚‹ãƒ‘ã‚¹:', targetPath);
            
            // å‰Šé™¤å‡¦ç†é–‹å§‹
            showProgressBanner();
            document.querySelector('.banner-title').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ä¸­...';
            document.querySelector('.banner-icon').textContent = 'ğŸ—‘ï¸';
            document.getElementById('bannerProgress').textContent = 'å‰Šé™¤å‡¦ç†ä¸­...';
            
            try {
                console.log('=== ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤APIå‘¼ã³å‡ºã— ===');
                const deleteResult = await window.electronAPI.forceDeleteFile(targetPath);
                console.log('å‰Šé™¤çµæœ:', deleteResult);
                
                hideProgressBanner();
                
                if (deleteResult && deleteResult.success) {
                    console.log('ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤æˆåŠŸ');
                    // å‰Šé™¤æˆåŠŸæ™‚ã¯å®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ‘ã‚¹ã‚‚ã‚¯ãƒªã‚¢ï¼‰
                    completeReset();
                    //alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                } else {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤å¤±æ•—:', deleteResult);
                    resetMergeState();
                    const errorMessage = deleteResult?.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    showDeleteErrorDialog(targetPath, errorMessage);
                }
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
                hideProgressBanner();
                resetMergeState();
                showDeleteErrorDialog(targetPath, error.message || 'å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // å‰Šé™¤ã‚¨ãƒ©ãƒ¼å°‚ç”¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        function showDeleteErrorDialog(filePath, errorMessage) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content error-modal">
                    <div class="modal-header">
                        <h3>âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼</h3>
                    </div>
                    <div class="modal-body">
                        <p>ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
                        <div class="error-details">
                            <strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong><br>
                            <code>${filePath}</code><br><br>
                            <strong>ã‚¨ãƒ©ãƒ¼:</strong><br>
                            <span class="error-message">${errorMessage}</span>
                        </div>
                        <div class="manual-delete-info">
                            <h4>æ‰‹å‹•ã§ã®å‰Šé™¤æ–¹æ³•:</h4>
                            <ol>
                                <li>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ä»–ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†</li>
                                <li>ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ å‰Šé™¤</li>
                                <li>ç®¡ç†è€…æ¨©é™ã§ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é–‹ã:<br>
                                    <code>del /f "${filePath}"</code></li>
                            </ol>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" id="openErrorFolderBtn">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã</button>
                        <button class="btn btn-secondary" id="closeErrorBtn">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('openErrorFolderBtn').onclick = async () => {
                await window.electronAPI.showInFolder(filePath);
                document.body.removeChild(modal);
            };
            
            document.getElementById('closeErrorBtn').onclick = () => {
                document.body.removeChild(modal);
            };
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
        function showCancelDialog() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content cancel-modal">
                        <div class="modal-header">
                            <h3>âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
                        </div>
                        <div class="modal-body">
                            <p>ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</p>
                            <p class="warning-text">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-danger" id="confirmCancelBtn">å‰Šé™¤ã™ã‚‹</button>
                            <button class="btn btn-secondary" id="continueMergeBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                document.getElementById('confirmCancelBtn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };
                
                document.getElementById('continueMergeBtn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
                
                // ESCã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', handleKeyDown);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ‰±ã„
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', handleKeyDown);
                        resolve(false);
                    }
                };
            });
        }

        // ä¸Šæ›¸ãç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        function showOverwriteDialog(filename) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™</h3>
                        </div>
                        <div class="modal-body">
                            <p><strong>${filename}</strong> ã¯æ—¢ã«å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚</p>
                            <p>ã©ã®ã‚ˆã†ã«å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ</p>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-danger" id="overwriteBtn">ä¸Šæ›¸ãã™ã‚‹</button>
                            <button class="btn btn-secondary" id="renameBtn">åå‰ã‚’å¤‰æ›´</button>
                            <button class="btn btn-outline" id="cancelOverwriteBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                document.getElementById('overwriteBtn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve('overwrite');
                };
                
                document.getElementById('renameBtn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve('rename');
                };
                
                document.getElementById('cancelOverwriteBtn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve('cancel');
                };
                
                // ESCã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', handleKeyDown);
                        resolve('cancel');
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', handleKeyDown);
                        resolve('cancel');
                    }
                };
            });
        }

        // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆæ­£ã—ã„é€£ç•ªå‡¦ç†ï¼‰
        async function generateUniqueFilename(folderPath, baseName) {
            let counter = 1;
            let newName;
            
            // æ—¢å­˜ã®é€£ç•ªã‚’æ¤œå‡ºã—ã¦æ¬¡ã®ç•ªå·ã‚’ç”Ÿæˆ
            const existingFiles = [];
            
            // (1), (2) ãªã©ã®ç•ªå·ãŒä»˜ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
            while (true) {
                const testName = `${baseName} (${counter})`;
                const testPath = folderPath + '\\' + sanitizeFilename(testName) + '.mp4';
                
                if (await window.electronAPI.checkFileExists(testPath)) {
                    existingFiles.push(counter);
                    counter++;
                } else {
                    // å­˜åœ¨ã—ãªã„ç•ªå·ãŒè¦‹ã¤ã‹ã£ãŸ
                    newName = testName;
                    break;
                }
                
                // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
                if (counter > 1000) {
                    newName = `${baseName} (${Date.now()})`;
                    break;
                }
            }
            
            console.log('Generated unique filename:', newName);
            return newName;
        }

        // é€²æ—ãƒãƒŠãƒ¼è¡¨ç¤º
        function showProgressBanner() {
            progressBanner.style.display = 'flex';
            progressBanner.classList.add('banner-show');
            
            // ãƒãƒŠãƒ¼ã‚’å°‘ã—é…ã‚‰ã›ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            setTimeout(() => {
                progressBanner.classList.add('banner-animate');
            }, 100);
        }

        // é€²æ—ãƒãƒŠãƒ¼éè¡¨ç¤º
        function hideProgressBanner() {
            progressBanner.classList.remove('banner-animate');
            setTimeout(() => {
                progressBanner.style.display = 'none';
                progressBanner.classList.remove('banner-show');
            }, 300);
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå…ƒã®å½¢ã«æˆ»ã™ï¼‰
        function showSuccessMessage(filePath) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content success-modal">
                    <div class="modal-header">
                        <h3>âœ… çµåˆå®Œäº†!</h3>
                    </div>
                    <div class="modal-body">
                        <p>å‹•ç”»ã®çµåˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚</p>
                        <div class="file-path-display">
                            <strong>ä¿å­˜å…ˆ:</strong><br>
                            <code>${filePath}</code>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" id="openFolderBtn">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã</button>
                        <button class="btn btn-secondary" id="closeSuccessBtn">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('openFolderBtn').onclick = async () => {
                await window.electronAPI.showInFolder(filePath);
                document.body.removeChild(modal);
                // ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã„ãŸå¾Œã¯å®Œå…¨åˆæœŸåŒ–
                fullReset();
            };
            
            document.getElementById('closeSuccessBtn').onclick = () => {
                document.body.removeChild(modal);
                // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã§ã¯å‰Šé™¤ã›ãšã€å˜ç´”ã«å®Œå…¨åˆæœŸåŒ–
                console.log('=== æˆåŠŸãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–‰ã˜ã‚‹ ===');
                fullReset();
            };
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚å‰Šé™¤ã›ãšã€å˜ç´”ã«å®Œå…¨åˆæœŸåŒ–
                    console.log('=== æˆåŠŸãƒ€ã‚¤ã‚¢ãƒ­ã‚°å¤–ã‚¯ãƒªãƒƒã‚¯ ===');
                    fullReset();
                }
            };
        }

        // é€²æ—æ›´æ–°ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ã—ãŸãŸã‚ä¸è¦ã ãŒã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã«ä¿æŒï¼‰
        window.electronAPI.onMergeProgress((event, progress) => {
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹ç›£è¦–ã‚’ãƒ¡ã‚¤ãƒ³ã¨ã—ã€ã“ã‚Œã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            console.log('FFmpegé€²æ—å—ä¿¡ï¼ˆå‚è€ƒç”¨ï¼‰:', progress);
        });

        // timemarkã‚’ç§’ã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function parseTimemarkToSeconds(timemark) {
            if (!timemark || timemark === '00:00:00') return 0;
            
            try {
                const parts = timemark.split(':');
                if (parts.length >= 3) {
                    const hours = parseInt(parts[0]) || 0;
                    const minutes = parseInt(parts[1]) || 0;
                    const seconds = parseFloat(parts[2]) || 0;
                    return hours * 3600 + minutes * 60 + seconds;
                }
            } catch (error) {
                console.warn('Timemark parse error:', error);
            }
            
            return 0;
        }

        // åˆæœŸåŒ–
        updateMergeButton();
    </script>
</body>
</html>